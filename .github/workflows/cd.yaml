name: CD Pipeline

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]

permissions:
  contents: write
  packages: write

concurrency:
  group: ${{ format('{0}-{1}', github.workflow, github.event.workflow_run.head_branch) }}
  cancel-in-progress: true

jobs:
  deploy:
    # only run when CI succeeded and branch is main or develop
    if: ${{ github.event.workflow_run.conclusion == 'success' && (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'develop') }}
    runs-on: ubuntu-latest

    env:
      # choose env dir based on branch
      ENV_DIR: ${{ github.event.workflow_run.head_branch == 'main' && 'deploy/helm/task-manager' || 'deploy/helm/task-manager' }}
      TAG_ENV: ${{ github.event.workflow_run.head_branch == 'main' && 'prod' || 'sandbox' }}
      SHA_TAG: ${{ github.event.workflow_run.head_sha || github.sha }}

    steps:
      - name: Checkout repo at the CI commit (head_sha)
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.workflow_run.head_sha }}
          fetch-depth: 0
          persist-credentials: true

      - name: Switch to the original branch
        run: |
          git checkout ${{ github.event.workflow_run.head_branch }}

      - name: Set GHCR_REPO (lowercase)
        run: echo "GHCR_REPO=ghcr.io/$(echo ${{ github.repository }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Set up Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build & push backend image
        uses: docker/build-push-action@v6
        with:
          context: ./apps/api
          file: ./apps/api/Dockerfile
          push: true
          tags: |
            ${{ env.GHCR_REPO }}/backend:${{ env.SHA_TAG }}
            ${{ env.GHCR_REPO }}/backend:${{ env.TAG_ENV }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ env.SHA_TAG }}

      - name: Build & push frontend image
        uses: docker/build-push-action@v6
        with:
          # Use repo root as context so workspace packages (packages/*) are available
          context: .
          file: ./apps/web/Dockerfile
          push: true
          build-args: |
            NEXT_PUBLIC_API_URL=/api
          tags: |
            ${{ env.GHCR_REPO }}/frontend:${{ env.SHA_TAG }}
            ${{ env.GHCR_REPO }}/frontend:${{ env.TAG_ENV }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ env.SHA_TAG }}

      - name: Build & push tgbot image
        uses: docker/build-push-action@v6
        with:
          # Build tgbot from repo root so workspace packages are available
          context: .
          file: ./apps/tg-bot/Dockerfile
          push: true
          tags: |
            ${{ env.GHCR_REPO }}/tgbot:${{ env.SHA_TAG }}
            ${{ env.GHCR_REPO }}/tgbot:${{ env.TAG_ENV }}
          labels: |
            org.opencontainers.image.source=${{ github.repository }}
            org.opencontainers.image.revision=${{ env.SHA_TAG }}

      - name: Install mikefarah yq (v4)
        run: |
          sudo wget -qO /usr/bin/yq https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64
          sudo chmod +x /usr/bin/yq
          yq --version

      - name: Bump image tag in Helm values (backend)
        run: |
          VALUES="${ENV_DIR}/values.yaml"
          mkdir -p "$(dirname "$VALUES")"
          touch "$VALUES"
          GHCR_REPO="${GHCR_REPO}" SHA_TAG="${SHA_TAG}" \
          yq -i '
            .image.repository = (strenv(GHCR_REPO) + "/backend") |
            .image.tag  = strenv(SHA_TAG)    |
            del(.image.repository_old)
          ' "$VALUES"

      - name: Commit & push changes (values.yaml) with [skip ci]
        run: |
          git config user.name "ci-cd-bot"
          git config user.email "bot@users.noreply.github.com"
          git add "${ENV_DIR}/values.yaml"
          if git commit -m "deploy: ${SHA_TAG} -> ${ENV_DIR} [skip ci]"; then
            git push origin ${{ github.event.workflow_run.head_branch }}
          else
            echo "No changes to commit"
          fi

      - name: Bump task-manager production Helm values (image.repository + image.tag)
        run: |
          FILE="deploy/helm/task-manager/values-production.yaml"
          # Ensure file exists
          test -f "$FILE" || touch "$FILE"
          GHCR_REPO="${GHCR_REPO}" SHA_TAG="${SHA_TAG}" \
          yq -i '.image.repository = (strenv(GHCR_REPO) + "/backend") | .image.tag = strenv(SHA_TAG)' "$FILE"

      - name: Commit & push values-production.yaml bump [skip ci]
        run: |
          git config user.name "ci-cd-bot"
          git config user.email "bot@users.noreply.github.com"
          git add deploy/helm/task-manager/values-production.yaml
          if git commit -m "deploy: bump task-manager image -> ${SHA_TAG} [skip ci]"; then
            git push origin ${{ github.event.workflow_run.head_branch }}
          else
            echo "No changes to commit"
          fi

      - name: Bump task-web Helm values (image.repository + image.tag)
        run: |
          FILE="deploy/helm/task-web/values.yaml"
          # Ensure file exists
          test -f "$FILE" || touch "$FILE"
          GHCR_REPO="${GHCR_REPO}" SHA_TAG="${SHA_TAG}" \
          yq -i '.image.repository = (strenv(GHCR_REPO) + "/frontend") | .image.tag = strenv(SHA_TAG)' "$FILE"

      - name: Commit & push task-web values bump [skip ci]
        run: |
          git config user.name "ci-cd-bot"
          git config user.email "bot@users.noreply.github.com"
          git add deploy/helm/task-web/values.yaml
          if git commit -m "deploy: bump task-web image -> ${SHA_TAG} [skip ci]"; then
            git push origin ${{ github.event.workflow_run.head_branch }}
          else
            echo "No changes to commit"
          fi

      - name: Bump tg-bot Helm values (image.repository + image.tag)
        run: |
          FILE="deploy/helm/tg-bot/values.yaml"
          # Ensure file exists
          test -f "$FILE" || touch "$FILE"
          GHCR_REPO="${GHCR_REPO}" SHA_TAG="${SHA_TAG}" \
          yq -i '.image.repository = (strenv(GHCR_REPO) + "/tgbot") | .image.tag = strenv(SHA_TAG)' "$FILE"

      - name: Commit & push tg-bot values bump [skip ci]
        run: |
          git config user.name "ci-cd-bot"
          git config user.email "bot@users.noreply.github.com"
          git add deploy/helm/tg-bot/values.yaml
          if git commit -m "deploy: bump tg-bot image -> ${SHA_TAG} [skip ci]"; then
            git push origin ${{ github.event.workflow_run.head_branch }}
          else
            echo "No changes to commit"
          fi

  notify-argocd:
    needs: deploy
    runs-on: ubuntu-latest
    if: success()
    steps:
      - name: Trigger ArgoCD Sync (if configured)
        run: |
          echo "Image deployed successfully. Tags: ${{ env.SHA_TAG }}"
          echo "If you have ArgoCD configured, add an API call or webhook here to trigger sync."
